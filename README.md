# Telegram-бот "Камни онлайн"


## API

## Database
Слой database используется для непосредственного взаимодействия с базой данных бота.
Две сущности:
- User, обозначающий всех, кто пользуется ботом в роли клиента
- Lobby - сущность, управляющая лобби и логикой игры

Представляют собой обёртки над БД, с кешированием, и представлены двумя singletone-классами

В приложении для управления игрой необходим первоначальный администратор (Supreme Admin),
который будет впоследствии назначать других администраторов. Чтобы указать ID этого Supreme Admin,
можно передать Telegram ID этого пользователя в `docker-compose.yml` в поле `SUPREME_ADMIN_ID`.
Либо же можно ID задать как переменную окружения, назвав её `SUPREME_ADMIN_ID`.

В качестве СУБД используется PostgreSQL-17.0

#### Изменение данных в БД во время работы бота может привести к конфликтам из-за кеширования, желательно все изменения производить через сущности.

Каждое лобби - отдельная схема в БД, изолированная от остальных

При остановке БД, состояние игры сохраняется (если что-то не сохраняется, считать багом)

## Взаимодействие с Telegram

### Создание бота

Чтобы развернуть приложение понадобиться создать собственного бота внутри Telegram. Это делается с помощью [BotFather](https://t.me/BotFather) внутри
Телеграма. С подробной инструкцией по созданию бота можно ознакомиться [здесь](https://botcreators.ru/blog/kak-sozdat-svoego-bota-v-botfather/).
После того, как вы создадите своего бота, вам необходимо вставить его токен в файл `.env` в той же папке, где находится файл `main.py`
```
BOT_TOKEN = 123456789:ABC1DEfNRBORn2459
```

### Назначение администраторов

Для того, чтобы назначить других пользователей на роль Администратора, эти пользователи должны отправить запрос с помощью команды `/request`.
После этой команды, уведомление приходит к Supreme администратору, который может либо принять этот запрос и назначить данного пользователя
администратором, либо отклонить запрос.

### Удаление с поста администратора

Для того, чтобы снять кого-либо с должности администратора, Supreme администратор должен воспользоваться командой `/admins`, которая выводит
список всех администраторов (кроме Supreme) и позволяет каждого из списка снять с должности.

### Создание лобби

Любой администратор может создать игру. Для этого он должен не находиться в лобби. Если он не в лобби, то у него присутствует кнопка "Создать лобби".
После нажатия этой кнопки, администратору даётся возможность выбрать длительность одного раунда в минутах и количество камней в каждом раунде.
После введения корректных данных лобби создаётся.

### Вход в лобби

Войти в лобби может каждый пользователь. Разграничение заключается лишь в том, что администраторы могут входить в лобби, в которых идёт игра, а обычные
пользователи нет. Обычный пользователь входит всегда как игрок, а администратор -- как управляющий игрок (соответственно сам он играть не может).

Вход осуществляется по кнопке "Войти в лобби".

### Выход из лобби

Обычный пользователь может выйти из лобби только когда лобби находится в ожидании игроков, т.е. когда игра ещё не запущена.
Администратор может выйти из лобби в любой момент времени.

Выход осуществляется с помощью кнопки "Выйти из лобби".

### Запуск игры

Любой администратор лобби может запустить игру с помощью кнопки "Начать игру", если в лобби находится не менее 2 игроков.

### Ход игры

Игра состоит из нескольких раундов. Каждый новый раунд запускается вручную администратором в лобби.

Каждый раунд длится определённое количество времени, установленного заранее создателем лобби. За это время игроки
должны убрать все камни с поля. Раунд разбит на несколько ходов, в течение каждого из которых каждый из игроков
должен сделать выбор к какому камню ему подойти. Игрок также может отойти от камней, что также считается выбором.
Ход идёт до тех пор, пока все игроки не сделают выбор. Раунд может закончиться раньше, если игроки успеют убрать все камни.

### Конец игры

После очередного раунда администраторы могут заврешить игру нажатием кнопки "Закончить игру". Тогда все игроки автоматически
выйдут из лобби, а администраторам придут логи игры в виде .csv файла.

## Запуск и развёртка

Приложение запускается при помощи Docker, для Dockerfile можно найти в репозитории, также параллельно поднимается контейнер с БД

```dockerfile
docker compose up
```

Автоматически поднимает два контейнера - с приложением и с БД, устанавливая все зависимости и инициализируя БД.

При запуске может возникнуть конфликт портов, если на используемых (5000 для приложения и 5432 для БД) уже что-то запущено.

Проверить это можно с помощью команды

```bash
sudo lsof -i -P -n | grep LISTEN | grep 5432
```
## API

- `/get_lobby_ids/` - эндпоинт возвращает список идентификаторов доступных лобби. 
